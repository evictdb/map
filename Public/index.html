<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Evictions Map</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
  </head>
  <body>
    <div id="map"></div>

    <script type="module">
const serviceUrl = 'https://services.arcgis.com/cNo3jpluyt69V8Ek/ArcGIS/rest/services/PublicParcel/FeatureServer/';
const layer = '0';

const esrijsonFormat = new ol.format.EsriJSON();

var vectorSource = new ol.source.Vector({
  loader: function (extent, resolution, projection) {
    var url =
      serviceUrl +
      layer +
      '/query/?f=json&' +
      'returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometry=' +
      encodeURIComponent(
        '{"xmin":' +
          extent[0] +
          ',"ymin":' +
          extent[1] +
          ',"xmax":' +
          extent[2] +
          ',"ymax":' +
          extent[3] +
          ',"spatialReference":{"wkid":102100}}'
      ) +
      '&geometryType=esriGeometryEnvelope&inSR=102100&outFields=*' +
      '&outSR=102100';
    $.ajax({
      url: url,
      dataType: 'jsonp',
      success: function (response) {
        if (response.error) {
          alert(
            response.error.message + '\n' + response.error.details.join('\n')
          );
        } else {
          // dataProjection will be read from document
          var features = esrijsonFormat.readFeatures(response, {
            featureProjection: projection,
          });
          if (features.length > 0) {
            vectorSource.addFeatures(features);
          }
        }
      },
    });
  },
  strategy: ol.loadingstrategy.tile(
    ol.tilegrid.createXYZ({
      tileSize: 512,
    })
  ),
});

const style = new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(255, 0, 0, 255)',
    }),
    stroke: new ol.style.Stroke({
      color: 'rgba(110, 110, 110, 255)',
      width: 0.4,
    })
  });

var vector = new ol.layer.Vector({
  source: vectorSource,
  style: style,
});

      const map = new ol.Map({
        target: "map", // the id of the div element
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vector
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([-82.37, 29.63]),
          zoom: 14
        }),
        // attribution:
        //         '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        //     },
        //   },
        //   layers: [
        //     {
        //       id: "simple-tiles",
        //       type: "raster",
        //       source: "raster-tiles",
        //       minzoom: 0,
        //       maxzoom: 20,
        //     },
        //   ],
        // },
      });
      // map.on("load", function () {
      //   map.addSource("eviction-cases", {
      //     type: "geojson",
      //     data: "eviction-cases.geojson",
      //   });

      //   map.addLayer({
      //     id: "evictions-heat",
      //     type: "heatmap",
      //     source: "eviction-cases",
      //     maxzoom: 15,
      //     paint: {
      //       // increase weight as diameter breast height increases
      //       "heatmap-weight": {
      //         property: "dbh",
      //         type: "exponential",
      //         stops: [
      //           [1, 0],
      //           [62, 1],
      //         ],
      //       },
      //       // increase intensity as zoom level increases
      //       "heatmap-intensity": {
      //         stops: [
      //           [11, 1],
      //           [15, 3],
      //         ],
      //       },
      //       // assign color values be applied to points depending on their density
      //       "heatmap-color": [
      //         "interpolate",
      //         ["linear"],
      //         ["heatmap-density"],
      //         0,
      //         "rgba(236,222,239,0)",
      //         0.2,
      //         "rgb(208,209,230)",
      //         0.4,
      //         "rgb(166,189,219)",
      //         0.6,
      //         "rgb(103,169,207)",
      //         0.8,
      //         "rgb(28,144,153)",
      //       ],
      //       // increase radius as zoom increases
      //       "heatmap-radius": {
      //         stops: [
      //           [11, 15],
      //           [15, 20],
      //         ],
      //       },
      //       // decrease opacity to transition into the circle layer
      //       "heatmap-opacity": {
      //         default: 1,
      //         stops: [
      //           [14, 1],
      //           [15, 0],
      //         ],
      //       },
      //     },
      //   });
      //   map.addLayer({
      //     id: "evictions-point",
      //     type: "circle",
      //     source: "eviction-cases",
      //     minzoom: 14,
      //     paint: {
      //       // increase the radius of the circle as the zoom level and dbh value increases
      //       "circle-radius": {
      //         property: "dbh",
      //         type: "exponential",
      //         stops: [
      //           [{ zoom: 15, value: 1 }, 5],
      //           [{ zoom: 15, value: 62 }, 10],
      //           [{ zoom: 22, value: 1 }, 20],
      //           [{ zoom: 22, value: 62 }, 50],
      //         ],
      //       },
      //       "circle-color": {
      //         property: "dbh",
      //         type: "exponential",
      //         stops: [
      //           [0, "rgba(236,222,239,0)"],
      //           [10, "rgb(236,222,239)"],
      //           [20, "rgb(208,209,230)"],
      //           [30, "rgb(166,189,219)"],
      //           [40, "rgb(103,169,207)"],
      //           [50, "rgb(28,144,153)"],
      //           [60, "rgb(1,108,89)"],
      //         ],
      //       },
      //       "circle-stroke-color": "white",
      //       "circle-stroke-width": 1,
      //       "circle-opacity": {
      //         stops: [
      //           [14, 0],
      //           [15, 1],
      //         ],
      //       },
      //     },
      //   });
      //   const bounds = map.getBounds();
      //   const center = map.getCenter();
      //   console.log(bounds, center);
      //   const box = [bounds._sw.lng + bounds._sw.lng - center.lng, bounds._sw.lat + bounds._sw.lat - center.lat, bounds._ne.lng + bounds._ne.lng - center.lng, bounds._ne.lat + bounds._ne.lat - center.lat];
      //   const dataUrl = `https://services.arcgis.com/cNo3jpluyt69V8Ek/ArcGIS/rest/services/PublicParcel/FeatureServer/0/query?f=pgeojson&geometryType=esriGeometryEnvelope&geometry=${box.join(',')}`;
      //   map.addSource("acpa-parcels", {
      //     type: "geojson",
      //     data: dataUrl,
      //   });
      //   map.addLayer({
      //     id: "parcels",
      //     type: "line",
      //     source: "acpa-parcels",
      //     paint: {
      //       "line-color": "hsla(239,80%,60%,0.75)",
      //     },
      //   });
      // });

      // map.addControl(
      //   new GeolocateControl({
      //     positionOptions: {
      //       enableHighAccuracy: true,
      //     },
      //   })
      // );

      // map.on("click", "evictions-point", function (e) {
      //   new Popup()
      //     .setLngLat(e.features[0].geometry.coordinates)
      //     .setHTML(
      //       `<ul>${["Case Number", "Filed", "Address"]
      //         .map(
      //           (field) =>
      //             `<li>${field}: <b>${e.features[0].properties[field]}</b></li>`
      //         )
      //         .join("")}</ul>`
      //     )
      //     .addTo(map);
      // });
    </script>
  </body>
</html>
